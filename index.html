<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>語意飽和實驗（GitHub Pages 版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jsPsych：使用 jsDelivr，GitHub Pages 100% 能載入 -->
  <link href="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/css/jspsych.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/jspsych.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/plugin-html-keyboard-response.js"></script>

  <style>
    body {
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #jspsych-target {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 0 16px;
    }

    .title {
      font-size: 32px;
      margin-bottom: 24px;
      font-weight: bold;
    }

    .instruction-text {
      font-size: 20px;
      text-align: left;
      line-height: 1.6;
    }

    .stim-target {
      font-size: 42px;
      font-weight: bold;
      margin-bottom: 18px;
    }

    .stim-distractor {
      font-size: 26px;
      opacity: 0.7;
    }

    .fix {
      font-size: 40px;
      font-weight: bold;
    }

    .small-note {
      font-size: 18px;
      margin-top: 10px;
      color: #555;
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    /********************************************
     * 初始化 jsPsych
     ********************************************/
    const jsPsych = initJsPsych({
      display_element: "jspsych-target",
      on_finish: function () {
        jsPsych.data.get().localSave("csv", "data_exp2.csv");
      }
    });

    const HtmlKeyboard = jsPsych.plugins["html-keyboard-response"];

    /********************************************
     * 刺激詞庫
     ********************************************/
    const fruits = [
      "芭樂", "藍莓", "草莓", "香蕉", "蓮霧", "蘋果", "柚子", "橘子", "榴槤",
      "奇異果", "火龍果", "葡萄柚", "李子", "水蜜桃", "龍眼", "荔枝", "木瓜",
      "鳳梨", "西瓜", "葡萄", "櫻桃", "哈密瓜", "柿子", "楊桃", "釋迦",
      "蔓越莓", "棗子", "水梨", "芒果", "百香果", "香瓜"
    ];

    const nonFruits = [
      "桌子", "鉛筆", "鞋子", "雨傘", "眼鏡", "電腦", "背包", "椅子",
      "毛巾", "手機", "書桌", "馬克杯", "耳機", "滑鼠", "衣櫃", "窗戶",
      "枕頭", "水瓶", "相機", "時鐘"
    ];

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function shuffle(arr) {
      let a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /********************************************
     * 產生正式試次
     ********************************************/
    const repetitions = 10;
    const trialVariables = [];

    const saturateLevels = [true, false];
    const sameCategoryLevels = [true, false];

    saturateLevels.forEach(sat => {
      sameCategoryLevels.forEach(same => {
        for (let i = 0; i < repetitions; i++) {
          const targetIsFruit = Math.random() < 0.5;

          let target = targetIsFruit ? pick(fruits) : pick(nonFruits);
          let distractor;

          if (same) {
            distractor = targetIsFruit ? pick(fruits) : pick(nonFruits);
          } else {
            distractor = targetIsFruit ? pick(nonFruits) : pick(fruits);
          }

          if (target === distractor) {
            distractor = targetIsFruit ? pick(fruits) : pick(nonFruits);
          }

          trialVariables.push({
            target,
            distractor,
            target_is_fruit: targetIsFruit,
            distractor_is_fruit: !targetIsFruit,
            saturate: sat,
            same_category: same
          });
        }
      });
    });

    /********************************************
     * 指示
     ********************************************/
    const instructions = {
      type: HtmlKeyboard,
      stimulus: `
        <div class="title">語意飽和實驗（二詞）</div>
        <div class="instruction-text">
          <p>你會看到兩個詞：</p>
          <ul>
            <li><b>中央大字：目標詞</b>（你要判斷是不是水果）</li>
            <li><b>小字：干擾詞</b>（請忽略）</li>
          </ul>
          <p>按鍵：</p>
          <ul>
            <li><b>F = 是水果</b></li>
            <li><b>J = 不是水果</b></li>
            <li><b>K = 不確定</b></li>
          </ul>
        </div>
        <p style="font-size:22px;">按任意鍵開始</p>
      `
    };

    /********************************************
     * 凝視點
     ********************************************/
    const fixation = {
      type: HtmlKeyboard,
      stimulus: `<div class="fix">+</div>`,
      trial_duration: 500,
      choices: "NO_KEYS"
    };

    /********************************************
     * 語意飽和（干擾詞重複）
     ********************************************/
    const saturatePhase = {
      timeline: [
        {
          type: HtmlKeyboard,
          stimulus: () => `<div class="stim-distractor">${jsPsych.timelineVariable("distractor")}</div>`,
          trial_duration: 200,
          choices: "NO_KEYS"
        },
        { type: HtmlKeyboard, stimulus: "", trial_duration: 80, choices: "NO_KEYS" }
      ],
      repetitions: 20,
      conditional_function: () =>
        jsPsych.timelineVariable("saturate") === true
    };

    /********************************************
     * 控制組（干擾詞一次）
     ********************************************/
    const singleDistractor = {
      type: HtmlKeyboard,
      stimulus: () => `<div class="stim-distractor">${jsPsych.timelineVariable("distractor")}</div>`,
      trial_duration: 500,
      choices: "NO_KEYS",
      conditional_function: () =>
        jsPsych.timelineVariable("saturate") === false
    };

    /********************************************
     * 空白
     ********************************************/
    const blank = {
      type: HtmlKeyboard,
      stimulus: "",
      trial_duration: 200,
      choices: "NO_KEYS"
    };

    /********************************************
     * 作答畫面
     ********************************************/
    const targetScreen = {
      type: HtmlKeyboard,
      stimulus: () => `
        <div class="stim-target">${jsPsych.timelineVariable("target")}</div>
        <div class="stim-distractor">${jsPsych.timelineVariable("distractor")}</div>
        <div class="small-note">F：是水果　J：不是水果　K：不確定</div>
      `,
      choices: ["f", "j", "k"],
      data: {
        phase: "test",
        target: jsPsych.timelineVariable("target"),
        distractor: jsPsych.timelineVariable("distractor"),
        target_is_fruit: jsPsych.timelineVariable("target_is_fruit"),
        saturate: jsPsych.timelineVariable("saturate"),
        same_category: jsPsych.timelineVariable("same_category")
      },
      on_finish: data => {
        const correct = data.target_is_fruit ? "f" : "j";
        data.correct = (data.response === correct);
      }
    };

    /********************************************
     * 主實驗流程
     ********************************************/
    const main = {
      timeline: [fixation, saturatePhase, singleDistractor, blank, targetScreen],
      timelineVariables: shuffle(trialVariables)
    };

    /********************************************
     * 結束
     ********************************************/
    const ending = {
      type: HtmlKeyboard,
      stimulus: `
        <div class="title">實驗完成</div>
        <p>感謝參與！資料已下載。</p>
        <p>按任意鍵結束。</p>
      `
    };

    jsPsych.run([instructions, main, ending]);
  </script>

</body>
</html>
