<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>實驗二：目標詞＋干擾詞（語意飽和）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 正確的 jsPsych 7.3.3 CDN -->
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet">
  <script src="https://unpkg.com/jspsych@7.3.3/dist/jspsych.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3/dist/plugin-html-keyboard-response.js"></script>

  <style>
    body {
      background: #f7f7f7;
    }

    #jspsych-target {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 0 16px;
    }

    .title {
      font-size: 32px;
      margin-bottom: 24px;
      font-weight: bold;
      text-align: center;
    }

    .instruction-text {
      font-size: 20px;
      text-align: left;
      line-height: 1.6;
    }

    .stim-target {
      font-size: 42px;
      font-weight: bold;
      margin-bottom: 18px;
    }

    .stim-distractor {
      font-size: 26px;
      opacity: 0.7;
    }

    .fix {
      font-size: 40px;
      font-weight: bold;
    }

    .small-note {
      font-size: 18px;
      margin-top: 10px;
      color: #555;
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    /* ===========================
       初始化 jsPsych
       =========================== */
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: function () {
        jsPsych.data.get().localSave('csv', 'exp2_two_word.csv');
      }
    });

    const HtmlKeyboard = jsPsych.plugins['html-keyboard-response'];

    /* ===========================
       刺激詞庫
       =========================== */

    const fruits = [
      "芭樂", "藍莓", "草莓", "香蕉", "蓮霧", "蘋果", "柚子", "橘子", "榴槤",
      "奇異果", "火龍果", "葡萄柚", "李子", "水蜜桃", "龍眼", "荔枝",
      "木瓜", "鳳梨", "西瓜", "葡萄", "櫻桃", "哈密瓜", "柿子",
      "楊桃", "釋迦", "蔓越莓", "棗子", "水梨", "芒果", "百香果", "香瓜"
    ];

    const nonFruits = [
      "桌子", "鉛筆", "鞋子", "雨傘", "眼鏡", "電腦", "背包", "椅子",
      "毛巾", "手機", "書桌", "馬克杯", "耳機", "滑鼠", "衣櫃", "窗戶",
      "枕頭", "水瓶", "相機", "時鐘"
    ];

    function shuffle(a) {
      let arr = a.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    /* ===========================
       產生正式 trial 
       =========================== */

    const trials = [];
    const repsPerCondition = 10;
    const saturateLevels = [true, false];
    const sameCatLevels = [true, false];

    saturateLevels.forEach(sat => {
      sameCatLevels.forEach(same => {
        for (let i = 0; i < repsPerCondition; i++) {

          const targetIsFruit = Math.random() < 0.5;
          let target = targetIsFruit ? pick(fruits) : pick(nonFruits);

          let distractor;
          let distractIsFruit;

          if (same) {
            distractor = targetIsFruit ? pick(fruits) : pick(nonFruits);
            distractIsFruit = targetIsFruit;
          } else {
            distractor = targetIsFruit ? pick(nonFruits) : pick(fruits);
            distractIsFruit = !targetIsFruit;
          }

          if (target === distractor) {
            distractor = distractIsFruit ? pick(fruits) : pick(nonFruits);
          }

          trials.push({
            target, distractor,
            target_is_fruit: targetIsFruit,
            distractor_is_fruit: distractIsFruit,
            saturate: sat,
            same_category: same
          });
        }
      });
    });

    const trialVars = shuffle(trials);

    /* ===========================
       說明
       =========================== */

    const instructions = {
      type: HtmlKeyboard,
      stimulus: `
      <div class="title">實驗二：詞語判斷任務</div>
      <div class="instruction-text">
        <p>每一題會同時看到兩個詞語：</p>
        <ul style="font-size:18px;">
          <li><b>大字（中央）是目標詞</b> — 你要判斷它是不是水果。</li>
          <li><b>小字是干擾詞</b> — 請盡量忽略。</li>
        </ul>
        <p>按鍵方式：</p>
        <ul style="font-size:18px;">
          <li><b>F：</b> 是水果</li>
          <li><b>J：</b> 不是水果</li>
          <li><b>K：</b> 不確定</li>
        </ul>
      </div>
      <p style="font-size:22px; margin-top:20px;">按任意鍵開始</p>
    `
    };

    /* ===========================
       凝視點
       =========================== */
    const fixation = {
      type: HtmlKeyboard,
      stimulus: `<div class="fix">+</div>`,
      choices: "NO_KEYS",
      trial_duration: 500
    };

    /* ===========================
       語意飽和：干擾詞重複呈現
       =========================== */
    const saturate_block = {
      timeline: [
        {
          type: HtmlKeyboard,
          stimulus: () => `<div class="stim-distractor">${jsPsych.timelineVariable('distractor')}</div>`,
          choices: "NO_KEYS",
          trial_duration: 250
        },
        {
          type: HtmlKeyboard,
          stimulus: "",
          choices: "NO_KEYS",
          trial_duration: 100
        }
      ],
      repetitions: 20,
      conditional_function: () => jsPsych.timelineVariable('saturate') === true
    };

    /* ===========================
       控制組：干擾詞呈現一次
       =========================== */
    const single_distractor = {
      type: HtmlKeyboard,
      stimulus: () => `<div class="stim-distractor">${jsPsych.timelineVariable('distractor')}</div>`,
      choices: "NO_KEYS",
      trial_duration: 500,
      conditional_function: () => jsPsych.timelineVariable('saturate') === false
    };

    /* ===========================
       空白間隔
       =========================== */
    const blank = {
      type: HtmlKeyboard,
      stimulus: "",
      choices: "NO_KEYS",
      trial_duration: 200
    };

    /* ===========================
       目標詞＋干擾詞同時呈現（作答）
       =========================== */
    const target_display = {
      type: HtmlKeyboard,
      stimulus: () => {
        const T = jsPsych.timelineVariable('target');
        const D = jsPsych.timelineVariable('distractor');
        return `
        <div class="stim-target">${T}</div>
        <div class="stim-distractor">${D}</div>
        <div class="small-note">F：是水果　J：不是水果　K：不確定</div>
        `;
      },
      choices: ['f', 'j', 'k'],
      data: {
        phase: "test",
        target: jsPsych.timelineVariable('target'),
        distractor: jsPsych.timelineVariable('distractor'),
        target_is_fruit: jsPsych.timelineVariable('target_is_fruit'),
        distractor_is_fruit: jsPsych.timelineVariable('distractor_is_fruit'),
        saturate: jsPsych.timelineVariable('saturate'),
        same_category: jsPsych.timelineVariable('same_category')
      },
      on_finish: data => {
        const correctKey = data.target_is_fruit ? 'f' : 'j';
        data.correct = (data.response === correctKey);
        data.correct_key = correctKey;
      }
    };

    const main_task = {
      timeline: [fixation, saturate_block, single_distractor, blank, target_display],
      timelineVariables: trialVars
    };

    /* ===========================
       結束畫面
       =========================== */
    const ending = {
      type: HtmlKeyboard,
      stimulus: `
        <div class="title">實驗結束</div>
        <p>謝謝你的參與！</p>
        <p class="small-note">資料將自動下載（CSV）。</p>
        <p>按任意鍵離開。</p>
      `
    };

    /* ===========================
       啟動
       =========================== */
    jsPsych.run([instructions, main_task, ending]);
  </script>

</body>
</html>
